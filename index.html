<!DOCTYPE html>
<html lang="es">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
<title>Santa Biblia â€” IA</title>
<link rel="manifest" href="./manifest.json">
<meta name="theme-color" content="#b8860b">
<meta name="apple-mobile-web-app-capable" content="yes">
<meta name="robots" content="noindex, nofollow">
<link href="https://fonts.googleapis.com/css2?family=Cinzel+Decorative:wght@400;700&family=Cinzel:wght@400;600&family=Crimson+Text:ital,wght@0,400;0,600;1,400&family=IBM+Plex+Mono:wght@400;500&display=swap" rel="stylesheet">
<style>
/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   GLOBAL
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
:root{
  --bg:#07040f;--s1:#0d0920;--s2:#11102a;--s3:#181636;
  --border:#1e1c3a;--border2:#2d2a52;
  --gold:#b8860b;--gold-l:#d4a017;--gold-b:#ffd700;
  --parch:#f5e6c8;--parch-d:rgba(245,230,200,.55);
  --red:#ef233c;--green:#06d6a0;--blue:#7690ff;--purple:#a78bfa;
  --muted:#5a5a80;--dim:#2e2a55;--text:#eeeef5;
  --teal:#06d6a0;
}
*{box-sizing:border-box;margin:0;padding:0}
body{background:var(--bg);color:var(--text);font-family:'Cinzel',serif;min-height:100vh;overflow-x:hidden}

/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   LOGIN SCREEN
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
.bg-login{position:fixed;inset:0;z-index:0;background:radial-gradient(ellipse at 50% 0%,#1a0d30,#07040f 65%)}
.bg-ray{position:absolute;top:-20%;left:50%;width:1px;transform-origin:top center;
  background:linear-gradient(to bottom,rgba(167,139,250,.15),transparent);animation:ray 9s ease-in-out infinite}
.bg-ray:nth-child(1){height:70vh;transform:rotate(-28deg);animation-delay:0s}
.bg-ray:nth-child(2){height:55vh;transform:rotate(-8deg);animation-delay:2s;opacity:.6}
.bg-ray:nth-child(3){height:65vh;transform:rotate(18deg);animation-delay:4s}
.bg-ray:nth-child(4){height:45vh;transform:rotate(38deg);animation-delay:6s;opacity:.5}
@keyframes ray{0%,100%{opacity:.25}50%{opacity:.7}}
.particles{position:absolute;inset:0}
.p-dot{position:absolute;border-radius:50%;background:var(--purple);animation:pfloat linear infinite;opacity:0}
@keyframes pfloat{0%{transform:translateY(100vh) scale(1);opacity:0}10%{opacity:.5}90%{opacity:.2}100%{transform:translateY(-10vh) scale(.3);opacity:0}}

#s-login{position:relative;z-index:10;min-height:100vh;display:flex;align-items:center;justify-content:center;padding:24px}

.card{width:min(420px,94vw);background:linear-gradient(160deg,#110d25,#0c0a1e,#161330);
  border:1px solid rgba(167,139,250,.25);border-radius:14px;
  padding:36px 32px 30px;box-shadow:0 0 60px rgba(124,58,237,.12),0 0 120px rgba(0,0,0,.8);
  animation:cardIn .6s ease both;position:relative}
.card::before{content:'';position:absolute;top:0;left:12%;right:12%;height:1.5px;
  background:linear-gradient(90deg,transparent,var(--purple),transparent);border-radius:2px}
@keyframes cardIn{from{opacity:0;transform:translateY(20px) scale(.97)}to{opacity:1;transform:none}}

.hdr{text-align:center;margin-bottom:26px}
.cross-wrap{width:58px;height:58px;margin:0 auto 14px;display:flex;align-items:center;
  justify-content:center;border-radius:50%;
  background:radial-gradient(circle,rgba(167,139,250,.2),transparent 70%);animation:cpulse 3s ease-in-out infinite}
@keyframes cpulse{0%,100%{box-shadow:0 0 0 0 rgba(167,139,250,.3)}50%{box-shadow:0 0 0 16px rgba(167,139,250,0)}}
.cross-icon{font-size:34px;filter:drop-shadow(0 0 10px rgba(167,139,250,.8))}
.hdr-title{font-family:'Cinzel Decorative',serif;font-size:16px;color:var(--purple);
  letter-spacing:1px;text-shadow:0 0 20px rgba(167,139,250,.4)}
.hdr-sub{font-size:9px;letter-spacing:4px;color:var(--parch-d);margin-top:5px;text-transform:uppercase;font-family:'Cinzel',serif}

.divider-ln{display:flex;align-items:center;gap:10px;margin-bottom:20px;color:rgba(167,139,250,.3);font-size:11px}
.divider-ln::before,.divider-ln::after{content:'';flex:1;height:1px;
  background:linear-gradient(90deg,transparent,rgba(167,139,250,.3),transparent)}

.field{margin-bottom:14px}
.field label{display:block;font-size:9px;letter-spacing:2px;color:rgba(167,139,250,.7);text-transform:uppercase;margin-bottom:6px}
.field-wrap{position:relative}
.field input{width:100%;background:rgba(167,139,250,.05);border:1px solid rgba(167,139,250,.18);
  border-radius:7px;padding:10px 38px 10px 13px;color:var(--parch);font-family:'Crimson Text',serif;
  font-size:15px;outline:none;transition:all .22s;-webkit-appearance:none}
.field input::placeholder{color:rgba(245,230,200,.2);font-style:italic}
.field input:focus{border-color:rgba(167,139,250,.6);background:rgba(167,139,250,.08);
  box-shadow:0 0 0 3px rgba(124,58,237,.1)}
.field input.ok{border-color:var(--green)!important}
.field input.fail{border-color:var(--red)!important}
.eye-btn{position:absolute;right:11px;top:50%;transform:translateY(-50%);background:none;border:none;
  color:var(--muted);cursor:pointer;font-size:14px;line-height:1;transition:color .2s}
.eye-btn:hover{color:var(--purple)}

#msg{min-height:18px;text-align:center;font-size:12px;letter-spacing:.5px;margin-bottom:13px;font-family:'Crimson Text',serif}
#msg.err{color:var(--red)}#msg.ok{color:var(--green)}#msg.info{color:var(--parch-d)}

.btn-enter{width:100%;padding:12px;background:linear-gradient(135deg,rgba(124,58,237,.8),rgba(167,139,250,.9),rgba(124,58,237,.8));
  background-size:200%;border:none;border-radius:7px;color:#fff;font-family:'Cinzel',serif;
  font-size:12px;font-weight:600;letter-spacing:3px;cursor:pointer;transition:all .3s;overflow:hidden}
.btn-enter:hover{background-position:100%;box-shadow:0 4px 20px rgba(124,58,237,.4)}
.btn-enter:active{transform:scale(.98)}
.btn-enter:disabled{opacity:.45;cursor:not-allowed;transform:none}
.btn-spin{display:none;width:15px;height:15px;border:2px solid rgba(255,255,255,.2);
  border-top-color:#fff;border-radius:50%;animation:spin .7s linear infinite;margin:0 auto}
@keyframes spin{to{transform:rotate(360deg)}}

/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   CHAT FAB â€” disponible desde que se escribe el nombre
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
#chat-fab{position:fixed;bottom:22px;right:22px;z-index:500;width:50px;height:50px;
  border-radius:50%;background:linear-gradient(135deg,#1a1040,#2d1a6e);
  border:1.5px solid rgba(167,139,250,.5);cursor:pointer;display:none;align-items:center;
  justify-content:center;font-size:20px;box-shadow:0 4px 20px rgba(124,58,237,.35);
  transition:all .25s;animation:fabPop .35s ease both}
@keyframes fabPop{from{transform:scale(0)}to{transform:scale(1)}}
#chat-fab:hover{transform:scale(1.1);box-shadow:0 6px 26px rgba(124,58,237,.55)}
.fab-badge{position:absolute;top:-5px;right:-5px;background:var(--red);color:#fff;
  font-size:9px;font-family:'IBM Plex Mono',monospace;width:17px;height:17px;border-radius:50%;
  display:none;align-items:center;justify-content:center;font-weight:700}

#chat-panel{position:fixed;bottom:84px;right:22px;z-index:500;width:min(310px,88vw);height:400px;
  background:linear-gradient(160deg,#0f0d25,#09071c);border:1px solid rgba(167,139,250,.25);
  border-radius:12px;display:none;flex-direction:column;
  box-shadow:0 8px 40px rgba(0,0,0,.75);overflow:hidden}
.chat-hdr{padding:11px 13px;background:rgba(124,58,237,.1);border-bottom:1px solid rgba(167,139,250,.18);
  display:flex;align-items:center;justify-content:space-between;flex-shrink:0}
.chat-hdr-title{font-size:10.5px;letter-spacing:2px;color:var(--purple)}
.chat-hdr-sub{font-size:9.5px;color:var(--parch-d);font-family:'Crimson Text',serif;margin-top:2px}
#chat-close-btn{background:none;border:none;color:var(--muted);font-size:16px;cursor:pointer;transition:color .2s;padding:0;line-height:1}
#chat-close-btn:hover{color:var(--purple)}
#chat-msgs{flex:1;overflow-y:auto;padding:10px;display:flex;flex-direction:column;gap:7px}
#chat-msgs::-webkit-scrollbar{width:3px}
#chat-msgs::-webkit-scrollbar-thumb{background:rgba(167,139,250,.25);border-radius:2px}
.cmsg{max-width:83%;padding:6px 10px;border-radius:9px;font-size:12.5px;font-family:'Crimson Text',serif;
  line-height:1.4;word-break:break-word}
.cmsg-mine{align-self:flex-end;background:rgba(124,58,237,.2);border:1px solid rgba(167,139,250,.28);color:var(--parch)}
.cmsg-admin{align-self:flex-start;background:rgba(6,214,160,.08);border:1px solid rgba(6,214,160,.22);color:#a0f0dd}
.cmsg-from{font-family:'Cinzel',serif;font-size:8.5px;letter-spacing:.8px;opacity:.55;margin-bottom:2px}
.cmsg-time{font-family:'IBM Plex Mono',monospace;font-size:8px;opacity:.35;margin-top:2px;text-align:right}
.chat-empty-msg{text-align:center;color:var(--muted);font-size:11.5px;font-family:'Crimson Text',serif;padding:18px;opacity:.6;font-style:italic}
.chat-inp-row{padding:9px;border-top:1px solid rgba(167,139,250,.18);display:flex;gap:7px;flex-shrink:0}
#chat-inp{flex:1;background:rgba(167,139,250,.05);border:1px solid rgba(167,139,250,.18);
  border-radius:7px;padding:7px 10px;color:var(--parch);font-family:'Crimson Text',serif;
  font-size:13.5px;outline:none;resize:none}
#chat-inp:focus{border-color:rgba(167,139,250,.5)}
#chat-send-btn{width:34px;background:rgba(124,58,237,.7);border:none;border-radius:7px;
  color:#fff;font-size:14px;cursor:pointer;transition:all .2s;flex-shrink:0}
#chat-send-btn:hover{background:rgba(124,58,237,.95)}

/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   ADMIN PANEL â€” estilo ai-hub
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
#s-admin{display:none;height:100vh;overflow:hidden;flex-direction:column}
.adm-bar{height:48px;background:var(--s1);border-bottom:1px solid var(--border);
  display:flex;align-items:center;padding:0 16px;gap:12px;flex-shrink:0}
.adm-logo{font-family:'Cinzel Decorative',serif;font-size:13px;color:var(--purple);
  display:flex;align-items:center;gap:8px;flex-shrink:0}
.adm-logo-icon{width:26px;height:26px;background:rgba(124,58,237,.4);border:1px solid rgba(167,139,250,.4);
  border-radius:6px;display:flex;align-items:center;justify-content:center;font-size:12px}
.adm-logo-sub{font-size:8px;font-family:'Cinzel',serif;letter-spacing:3px;color:var(--muted);display:block}
.adm-stripe{flex:1;height:1px;background:linear-gradient(90deg,rgba(124,58,237,.4),transparent)}
.adm-stats-bar{display:flex;align-items:center;gap:10px;flex-shrink:0}
.adm-stat{background:rgba(124,58,237,.1);border:1px solid rgba(167,139,250,.18);border-radius:5px;
  padding:4px 12px;text-align:center}
.adm-stat-n{font-family:'IBM Plex Mono',monospace;font-size:13px;font-weight:700}
.adm-stat-l{font-size:8px;letter-spacing:1.5px;color:var(--muted);display:block}
.adm-logout-btn{background:rgba(239,35,60,.1);border:1px solid rgba(239,35,60,.3);border-radius:5px;
  padding:5px 12px;color:#ff6b7a;font-size:9px;letter-spacing:1px;cursor:pointer;transition:all .2s;font-family:'Cinzel',serif}
.adm-logout-btn:hover{background:rgba(239,35,60,.22)}

.adm-body{flex:1;overflow:hidden;display:flex;flex-direction:column}

/* Toolbar de la grilla */
.adm-grid-bar{padding:8px 14px;background:var(--s2);border-bottom:1px solid var(--border);
  display:flex;align-items:center;gap:8px;flex-shrink:0;flex-wrap:wrap}
.adm-grid-title{font-size:10px;font-weight:700;color:var(--teal);letter-spacing:1.5px;white-space:nowrap}
.adm-count-badge{background:rgba(6,214,160,.12);border:1px solid rgba(6,214,160,.3);
  border-radius:20px;padding:2px 10px;font-size:9px;font-family:'IBM Plex Mono',monospace;color:var(--teal)}
.adm-spacer{flex:1}
.adm-btn{border:none;border-radius:5px;padding:4px 10px;font-size:9px;letter-spacing:.5px;
  cursor:pointer;transition:all .18s;font-family:'Cinzel',serif}
.adm-btn-sec{background:var(--s3);border:1px solid var(--border2);color:var(--muted)}
.adm-btn-sec:hover{color:var(--text);border-color:var(--muted)}
.adm-btn-purple{background:rgba(124,58,237,.55);border:1px solid rgba(167,139,250,.4);color:var(--purple)}
.adm-btn-purple:hover{background:rgba(124,58,237,.8)}
.adm-btn-red{background:rgba(239,35,60,.1);border:1px solid rgba(239,35,60,.3);color:#ff6b7a}
.adm-btn-red:hover{background:rgba(239,35,60,.25)}
.adm-btn-green{background:rgba(6,214,160,.1);border:1px solid rgba(6,214,160,.3);color:var(--teal)}
.adm-btn-green:hover{background:rgba(6,214,160,.2)}

/* Grilla de usuarios + chat */
.adm-main-grid{flex:1;overflow:hidden;display:grid;grid-template-columns:1fr 340px}
@media(max-width:800px){.adm-main-grid{grid-template-columns:1fr}}

/* Usuarios */
.adm-users-col{overflow-y:auto;padding:10px}
.adm-users-col::-webkit-scrollbar{width:4px}
.adm-users-col::-webkit-scrollbar-thumb{background:var(--border2);border-radius:2px}

/* Session card â€” mismo estilo ai-hub */
.sc{background:var(--s2);border:1px solid var(--border);border-radius:9px;
  overflow:hidden;transition:opacity .2s,border-color .2s;margin-bottom:8px;position:relative}
.sc::before{content:'';position:absolute;top:0;left:0;right:0;height:2.5px;
  background:var(--teal);opacity:0;transition:opacity .3s}
.sc.online::before{opacity:1}
.sc.online{border-color:rgba(6,214,160,.25)}
.sc.offline{opacity:.5}
.sc-hdr{display:flex;align-items:center;gap:8px;padding:10px 12px;background:var(--s2);border-bottom:1px solid var(--border);flex-wrap:wrap}
.sc-av{width:36px;height:36px;border-radius:8px;display:flex;align-items:center;justify-content:center;
  font-size:14px;font-weight:800;flex-shrink:0;
  background:linear-gradient(135deg,rgba(124,58,237,.6),rgba(167,139,250,.4));
  border:1px solid rgba(167,139,250,.3);font-family:'Cinzel',serif;color:var(--purple)}
.sc-name{font-size:12px;font-weight:700;color:var(--parch);font-family:'Cinzel',serif}
.sc-email{font-size:10px;font-family:'IBM Plex Mono',monospace;color:var(--teal)}
.sc-dot{width:7px;height:7px;border-radius:50%;flex-shrink:0}
.sc-dot.on{background:var(--teal);box-shadow:0 0 6px var(--teal);animation:dotp 2s infinite}
.sc-dot.off{background:var(--dim)}
@keyframes dotp{0%,100%{opacity:1}50%{opacity:.3}}
.sc-status-lbl{font-size:9px;font-weight:700;letter-spacing:.5px;font-family:'IBM Plex Mono',monospace}
.sc-badge{font-size:8px;padding:1px 6px;border-radius:4px;font-weight:700;font-family:'IBM Plex Mono',monospace;white-space:nowrap}
.sc-badge-pre{background:rgba(255,214,10,.1);color:#ffd60a;border:1px solid rgba(255,214,10,.25)}
.sc-badge-in{background:rgba(6,214,160,.12);color:var(--teal);border:1px solid rgba(6,214,160,.25)}
.sc-badge-warn{background:rgba(239,35,60,.1);color:#ff6b7a;border:1px solid rgba(239,35,60,.25)}
.sc-time{font-size:9px;color:var(--muted);font-family:'IBM Plex Mono',monospace}

/* Info grid dentro de la card */
.sc-info{display:grid;grid-template-columns:repeat(3,1fr);gap:0;border-bottom:1px solid var(--border)}
.sc-info-cell{padding:8px 10px;border-right:1px solid var(--border);min-width:0}
.sc-info-cell:last-child{border-right:none}
.sc-info-label{font-size:8px;color:var(--muted);letter-spacing:1px;text-transform:uppercase;margin-bottom:3px}
.sc-info-val{font-size:10.5px;font-family:'IBM Plex Mono',monospace;color:var(--text);
  overflow:hidden;text-overflow:ellipsis;white-space:nowrap}

/* Botones de acciÃ³n en la card */
.sc-actions{display:flex;gap:5px;padding:8px 10px;background:rgba(0,0,0,.2);flex-wrap:wrap}

/* Chat column del admin */
.adm-chat-col{border-left:1px solid var(--border);display:flex;flex-direction:column;overflow:hidden}
@media(max-width:800px){.adm-chat-col{display:none}}
.adm-chat-topbar{padding:8px 12px;background:var(--s2);border-bottom:1px solid var(--border);
  display:flex;align-items:center;justify-content:space-between;flex-shrink:0}
.adm-chat-title{font-size:10px;letter-spacing:1.5px;color:var(--purple)}
.adm-chat-badge{background:rgba(239,35,60,.2);border:1px solid rgba(239,35,60,.4);
  border-radius:20px;padding:1px 8px;font-size:9px;font-family:'IBM Plex Mono',monospace;color:#ff6b7a;display:none}

.adm-msgs{flex:1;overflow-y:auto;padding:10px;display:flex;flex-direction:column;gap:6px}
.adm-msgs::-webkit-scrollbar{width:3px}
.adm-msgs::-webkit-scrollbar-thumb{background:var(--border2);border-radius:2px}
.admsg{border-radius:7px;padding:7px 10px;font-size:12px;font-family:'Crimson Text',serif;line-height:1.4;word-break:break-word}
.adm-msg-user{align-self:flex-start;background:rgba(245,230,200,.05);
  border:1px solid rgba(245,230,200,.1);color:var(--parch)}
.adm-msg-admin{align-self:flex-end;background:rgba(124,58,237,.15);
  border:1px solid rgba(167,139,250,.25);color:var(--purple)}
.adm-msg-from{font-family:'Cinzel',serif;font-size:8.5px;letter-spacing:.5px;opacity:.55;margin-bottom:2px}
.adm-msg-time{font-family:'IBM Plex Mono',monospace;font-size:8px;opacity:.35;margin-top:2px}
.adm-msg-pre{font-style:italic;font-size:8.5px;color:var(--muted);margin-top:1px}
.adm-chat-empty{text-align:center;color:var(--muted);font-size:11.5px;font-family:'Crimson Text',serif;padding:20px;opacity:.5;font-style:italic}

.adm-chat-inp{padding:9px;border-top:1px solid var(--border);flex-shrink:0;display:flex;flex-direction:column;gap:6px}
.adm-to-row{display:flex;align-items:center;gap:6px}
.adm-to-lbl{font-size:8.5px;color:var(--muted);letter-spacing:1px;white-space:nowrap}
#adm-to{flex:1;background:var(--bg);border:1px solid var(--border2);border-radius:5px;
  padding:4px 8px;color:var(--text);font-size:10px;font-family:'Cinzel',serif;outline:none}
#adm-to option{background:#0d0920}
.adm-send-row{display:flex;gap:7px}
#adm-inp{flex:1;background:rgba(124,58,237,.06);border:1px solid rgba(167,139,250,.18);
  border-radius:7px;padding:7px 10px;color:var(--parch);font-size:13px;font-family:'Crimson Text',serif;outline:none}
#adm-inp:focus{border-color:rgba(167,139,250,.5)}
#adm-send{background:rgba(124,58,237,.7);border:none;border-radius:7px;width:34px;
  color:#fff;font-size:14px;cursor:pointer;transition:all .2s;flex-shrink:0}
#adm-send:hover{background:rgba(124,58,237,.95)}

/* Firebase setup */
.fb-banner{background:rgba(255,180,0,.08);border:1px solid rgba(255,180,0,.3);
  border-radius:8px;padding:12px 14px;margin:10px;font-size:11.5px;color:#ffe}
.fb-banner input{width:100%;margin-top:7px;background:rgba(255,255,255,.06);
  border:1px solid rgba(255,180,0,.35);border-radius:5px;padding:6px 9px;
  color:#ffe;font-size:12px;font-family:'IBM Plex Mono',monospace;outline:none}
.fb-banner button{margin-top:7px;width:100%;padding:6px;background:rgba(255,180,0,.2);
  border:1px solid rgba(255,180,0,.4);border-radius:5px;color:#ffe;
  font-family:'Cinzel',serif;font-size:9px;letter-spacing:1px;cursor:pointer}
.fb-banner button:hover{background:rgba(255,180,0,.35)}

/* Edit modal */
#modal-edit{display:none;position:fixed;inset:0;z-index:900;background:rgba(0,0,0,.78);
  align-items:center;justify-content:center}
#modal-edit.show{display:flex}
.modal-box{background:linear-gradient(160deg,#110d25,#080618);border:1px solid rgba(167,139,250,.3);
  border-radius:12px;padding:26px;width:min(380px,90vw);box-shadow:0 0 50px rgba(124,58,237,.2)}
.modal-title{font-size:12px;letter-spacing:2px;color:var(--purple);margin-bottom:18px;text-align:center}
.modal-subtitle{font-size:10px;color:var(--muted);text-align:center;margin-bottom:16px;font-family:'IBM Plex Mono',monospace}
.modal-field{margin-bottom:12px}
.modal-field label{display:block;font-size:8.5px;letter-spacing:1.5px;color:rgba(167,139,250,.65);text-transform:uppercase;margin-bottom:5px}
.modal-field input{width:100%;background:rgba(124,58,237,.08);border:1px solid rgba(167,139,250,.22);
  border-radius:6px;padding:8px 11px;color:var(--parch);font-size:13.5px;font-family:'Crimson Text',serif;outline:none}
.modal-btns{display:flex;gap:9px;margin-top:18px}
.modal-btns button{flex:1;padding:9px;border:none;border-radius:7px;font-family:'Cinzel',serif;font-size:10px;letter-spacing:1px;cursor:pointer;transition:all .2s}
.modal-save{background:rgba(124,58,237,.8);color:#fff}
.modal-save:hover{background:rgba(124,58,237,1)}
.modal-cancel{background:rgba(245,230,200,.06);color:var(--parch-d)}
.modal-cancel:hover{background:rgba(245,230,200,.12)}

/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   LOADING
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
#s-load{display:none;position:fixed;inset:0;z-index:800;background:var(--bg);
  flex-direction:column;align-items:center;justify-content:center;gap:20px}
#s-load.show{display:flex}
.ld-cross{font-size:56px;animation:ldglow 2s ease-in-out infinite alternate}
@keyframes ldglow{from{text-shadow:0 0 20px rgba(167,139,250,.4)}to{text-shadow:0 0 50px rgba(167,139,250,.9),0 0 80px rgba(167,139,250,.3)}}
.ld-title{font-family:'Cinzel Decorative',serif;font-size:15px;color:var(--purple);letter-spacing:2px;text-align:center}
.ld-pw{width:220px;height:2px;background:rgba(167,139,250,.15);border-radius:2px;overflow:hidden}
#ld-bar{height:100%;width:0%;background:linear-gradient(90deg,rgba(124,58,237,.8),var(--purple));
  transition:width .28s;box-shadow:0 0 8px rgba(167,139,250,.6)}
#ld-st{font-size:10px;letter-spacing:2px;color:var(--muted);font-family:'IBM Plex Mono',monospace}
</style>
</head>
<body>

<!-- â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• LOGIN â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• -->
<div class="bg-login" id="bg-login">
  <div class="bg-ray"></div><div class="bg-ray"></div>
  <div class="bg-ray"></div><div class="bg-ray"></div>
  <div class="particles" id="particles"></div>
</div>

<div id="s-login">
  <div class="card">
    <div class="hdr">
      <div class="cross-wrap"><span class="cross-icon">âœ</span></div>
      <div class="hdr-title">Santa Biblia</div>
      <div class="hdr-sub">Con Agente de Inteligencia Artificial</div>
    </div>
    <div class="divider-ln">ACCESO</div>
    <div class="field">
      <label>Nombre de usuario</label>
      <div class="field-wrap">
        <input type="text" id="f-user" placeholder="Tu nombreâ€¦" autocomplete="username" maxlength="40" oninput="onNameType(this.value)">
      </div>
    </div>
    <div class="field">
      <label>Clave IA de Texto</label>
      <div class="field-wrap">
        <input type="password" id="f-or" placeholder="Clave IA de Textoâ€¦" autocomplete="off" maxlength="120">
        <button class="eye-btn" type="button" onclick="toggleEye('f-or',this)" tabindex="-1">ğŸ‘</button>
      </div>
    </div>
    <div class="field">
      <label>Clave IA de ImÃ¡genes</label>
      <div class="field-wrap">
        <input type="password" id="f-horde" placeholder="Clave IA de ImÃ¡genesâ€¦" autocomplete="off" maxlength="80">
        <button class="eye-btn" type="button" onclick="toggleEye('f-horde',this)" tabindex="-1">ğŸ‘</button>
      </div>
    </div>
    <div id="msg" class="info"></div>
    <button class="btn-enter" id="btn-enter" onclick="doLogin()">
      <span id="btn-txt">ENTRAR</span>
      <div class="btn-spin" id="btn-spin"></div>
    </button>
  </div>
</div>

<!-- â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• CHAT FAB â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• -->
<button id="chat-fab" onclick="toggleChat()" style="display:none">
  ğŸ’¬<div class="fab-badge" id="fab-badge"></div>
</button>

<div id="chat-panel" style="display:none">
  <div class="chat-hdr">
    <div>
      <div class="chat-hdr-title">âœ CHAT CON ADMINISTRADOR</div>
      <div class="chat-hdr-sub" id="chat-hdr-sub">Puedes escribir antes de entrar</div>
    </div>
    <button id="chat-close-btn" onclick="toggleChat()">âœ•</button>
  </div>
  <div id="chat-msgs"><div class="chat-empty-msg">Inicia una conversaciÃ³nâ€¦</div></div>
  <div class="chat-inp-row">
    <textarea id="chat-inp" rows="1" placeholder="Escribe un mensajeâ€¦" onkeydown="chatEnter(event)"></textarea>
    <button id="chat-send-btn" onclick="sendUserMsg()">â¤</button>
  </div>
</div>

<!-- â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• ADMIN â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• -->
<div id="s-admin" style="display:none">
  <!-- Top bar -->
  <div class="adm-bar">
    <div class="adm-logo">
      <div class="adm-logo-icon">âœ</div>
      <div>Biblia Admin<span class="adm-logo-sub">PANEL DE CONTROL</span></div>
    </div>
    <div class="adm-stripe"></div>
    <div class="adm-stats-bar">
      <div class="adm-stat">
        <div class="adm-stat-n" id="stat-total" style="color:var(--purple)">0</div>
        <span class="adm-stat-l">USUARIOS</span>
      </div>
      <div class="adm-stat">
        <div class="adm-stat-n" id="stat-online" style="color:var(--teal)">0</div>
        <span class="adm-stat-l">EN LÃNEA</span>
      </div>
      <div class="adm-stat">
        <div class="adm-stat-n" id="stat-prelogin" style="color:#ffd60a">0</div>
        <span class="adm-stat-l">PRE-LOGIN</span>
      </div>
      <div class="adm-stat">
        <div class="adm-stat-n" id="stat-msgs" style="color:var(--blue)">0</div>
        <span class="adm-stat-l">MENSAJES</span>
      </div>
    </div>
    <button class="adm-logout-btn" onclick="adminLogout()">âœ• SALIR</button>
  </div>

  <div class="adm-body">
    <!-- Firebase setup banner -->
    <div id="fb-banner" class="fb-banner" style="display:none">
      âš™ <strong>Base de datos no configurada</strong> â€” Pega la URL de Firebase Realtime Database:
      <input id="fb-inp" type="text" placeholder="https://tu-proyecto-default-rtdb.firebaseio.com">
      <button onclick="saveFbUrl()">ğŸ’¾ GUARDAR Y ACTIVAR</button>
    </div>

    <div class="adm-grid-bar">
      <span class="adm-grid-title">ğŸ“¡ SESIONES</span>
      <span class="adm-count-badge" id="adm-count-badge">0 activas</span>
      <div class="adm-spacer"></div>
      <button class="adm-btn adm-btn-green" onclick="loadAdminData()">â†» Actualizar</button>
    </div>

    <div class="adm-main-grid">
      <!-- Columna usuarios -->
      <div class="adm-users-col" id="adm-users-col">
        <div id="adm-empty" style="text-align:center;padding:48px 20px;color:var(--muted)">
          <div style="font-size:2.5rem;opacity:.15;margin-bottom:12px">ğŸ“¡</div>
          <div style="font-size:12px;font-weight:700;color:var(--dim)">Sin usuarios registrados</div>
          <div style="font-size:11px;margin-top:6px;font-family:'Crimson Text',serif">Los usuarios aparecerÃ¡n aquÃ­ en cuanto inicien sesiÃ³n o envÃ­en un mensaje de chat</div>
        </div>
      </div>

      <!-- Columna chat admin -->
      <div class="adm-chat-col">
        <div class="adm-chat-topbar">
          <span class="adm-chat-title">MENSAJES DE CHAT</span>
          <span class="adm-chat-badge" id="adm-chat-badge">0 nuevos</span>
        </div>
        <div class="adm-msgs" id="adm-msgs"><div class="adm-chat-empty">Sin mensajes aÃºn.</div></div>
        <div class="adm-chat-inp">
          <div class="adm-to-row">
            <span class="adm-to-lbl">PARA:</span>
            <select id="adm-to"><option value="all">ğŸ“¢ Todos</option></select>
          </div>
          <div class="adm-send-row">
            <input id="adm-inp" placeholder="Mensaje del administradorâ€¦" onkeydown="if(event.key==='Enter')admSend()">
            <button id="adm-send" onclick="admSend()">â¤</button>
          </div>
        </div>
      </div>
    </div>
  </div>
</div>

<!-- Edit modal -->
<div id="modal-edit">
  <div class="modal-box">
    <div class="modal-title">âœ EDITAR CLAVES</div>
    <div class="modal-subtitle" id="modal-username">â€”</div>
    <div class="modal-field"><label>Nueva Clave IA de Texto</label><input type="text" id="modal-or" placeholder="Dejar vacÃ­o para no cambiar"></div>
    <div class="modal-field"><label>Nueva Clave IA de ImÃ¡genes</label><input type="text" id="modal-horde" placeholder="Dejar vacÃ­o para no cambiar"></div>
    <div class="modal-btns">
      <button class="modal-cancel" onclick="closeModal()">Cancelar</button>
      <button class="modal-save" onclick="saveModalKeys()">ğŸ’¾ Guardar</button>
    </div>
  </div>
</div>

<!-- Loading -->
<div id="s-load">
  <div class="ld-cross">âœ</div>
  <div class="ld-title">Abriendo las Escriturasâ€¦</div>
  <div class="ld-pw"><div id="ld-bar"></div></div>
  <div id="ld-st">Iniciandoâ€¦</div>
</div>

<script>
'use strict';

/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   CONSTANTES
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
const ADMIN_USER = 'Karel';
const ADMIN_PASS = 'K@rel.2255';

// Clave XOR para cifrado en Firebase
const _EK = ['Bib','lia','Sag','rad','a20','24_','Key','_Ci','f_X','OR_','Sec'];
const ENC_KEY = _EK.join('');

/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   CIFRADO XOR + BASE64
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
function enc(str) {
  if (!str) return '';
  const b = new TextEncoder().encode(String(str));
  const k = new TextEncoder().encode(ENC_KEY);
  const out = new Uint8Array(b.length);
  for (let i = 0; i < b.length; i++) out[i] = b[i] ^ k[i % k.length];
  return btoa(String.fromCharCode(...out));
}
function dec(b64) {
  if (!b64) return '';
  try {
    const bin = atob(b64);
    const b = new Uint8Array(bin.length);
    for (let i = 0; i < bin.length; i++) b[i] = bin.charCodeAt(i);
    const k = new TextEncoder().encode(ENC_KEY);
    const out = new Uint8Array(b.length);
    for (let i = 0; i < b.length; i++) out[i] = b[i] ^ k[i % k.length];
    return new TextDecoder().decode(out);
  } catch(e) { return ''; }
}
function userKey(name) {
  return btoa(encodeURIComponent(name.toLowerCase())).replace(/[+/=]/g,'_');
}

/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   FIREBASE REST
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
function getFbUrl() { return localStorage.getItem('biblia_fb_url') || ''; }
async function fbGet(path) {
  const url = getFbUrl(); if (!url) return null;
  try { const r = await fetch(url+path+'.json',{cache:'no-store'}); return r.ok ? r.json() : null; } catch(e) { return null; }
}
async function fbSet(path, data) {
  const url = getFbUrl(); if (!url) return false;
  try { return (await fetch(url+path+'.json',{method:'PUT',headers:{'Content-Type':'application/json'},body:JSON.stringify(data)})).ok; } catch(e) { return false; }
}
async function fbPatch(path, data) {
  const url = getFbUrl(); if (!url) return false;
  try { return (await fetch(url+path+'.json',{method:'PATCH',headers:{'Content-Type':'application/json'},body:JSON.stringify(data)})).ok; } catch(e) { return false; }
}
async function fbPush(path, data) {
  const url = getFbUrl(); if (!url) return null;
  try { const r = await fetch(url+path+'.json',{method:'POST',headers:{'Content-Type':'application/json'},body:JSON.stringify(data)}); return r.ok ? (await r.json()).name : null; } catch(e) { return null; }
}

/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   ESTADO
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
let _myName = '';
let _chatOpen = false;
let _chatPoll = null;
let _hbTimer = null;
let _newMsgs = 0;
let _lastMsgTs = 0;
let _editingKey = '';
let _isAdmin = false;
let _admPoll = null;
let _admNewMsgs = 0;

/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   UI HELPERS
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
const $id = id => document.getElementById(id);
function setMsg(t,cls='info') { $id('msg').textContent=t; $id('msg').className=cls; }
function setField(id,st) { const e=$id(id); e.classList.remove('ok','fail'); if(st) e.classList.add(st); }
function setBusy(b) {
  $id('btn-enter').disabled=b;
  $id('btn-txt').style.display=b?'none':'block';
  $id('btn-spin').style.display=b?'block':'none';
}
function toggleEye(id,btn) { const i=$id(id); i.type=i.type==='password'?'text':'password'; btn.textContent=i.type==='password'?'ğŸ‘':'ğŸ™ˆ'; }
function esc(s) { return String(s).replace(/&/g,'&amp;').replace(/</g,'&lt;').replace(/>/g,'&gt;').replace(/"/g,'&quot;'); }
function fmtTime(ts) { return new Date(ts).toLocaleTimeString('es',{hour:'2-digit',minute:'2-digit'}); }
function fmtDate(ts) { const d=new Date(ts); return d.toLocaleDateString('es',{day:'2-digit',month:'2-digit'})+' '+d.toLocaleTimeString('es',{hour:'2-digit',minute:'2-digit'}); }
function timeSince(ts) { const s=Math.floor((Date.now()-ts)/1000); if(s<60) return s+'s'; if(s<3600) return Math.floor(s/60)+'m'; return Math.floor(s/3600)+'h'; }

/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   PARTÃCULAS
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
(function() {
  const c = $id('particles');
  for (let i = 0; i < 14; i++) {
    const p = document.createElement('div'); p.className='p-dot';
    const sz = Math.random()*2.5+1;
    p.style.cssText=`width:${sz}px;height:${sz}px;left:${Math.random()*100}%;animation-duration:${Math.random()*22+16}s;animation-delay:${Math.random()*16}s;opacity:0`;
    c.appendChild(p);
  }
})();

/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   NOMBRE â†’ CHAT FAB
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
function onNameType(val) {
  _myName = val.trim();
  const fab = $id('chat-fab');
  if (_myName.length >= 2) {
    fab.style.display = 'flex';
    $id('chat-hdr-sub').textContent = 'Como: ' + _myName;
  } else {
    fab.style.display = 'none';
    if (_chatOpen) toggleChat();
  }
}

/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   API VALIDATION
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
async function checkOR(key) {
  try { return (await fetch('https://openrouter.ai/api/v1/models',{headers:{'Authorization':'Bearer '+key}})).ok; } catch(e) { return false; }
}
async function checkHorde(key) {
  try { return (await fetch('https://aihorde.net/api/v2/find_user',{headers:{'apikey':key,'Client-Agent':'BibliaSagradaIA:1.0'}})).ok; } catch(e) { return false; }
}

/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   CHAT â€” USUARIO
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
function toggleChat() {
  _chatOpen = !_chatOpen;
  const panel = $id('chat-panel');
  panel.style.display = _chatOpen ? 'flex' : 'none';
  if (_chatOpen) {
    _newMsgs = 0;
    $id('fab-badge').style.display = 'none';
    loadUserChat();
    if (!_chatPoll) _chatPoll = setInterval(loadUserChat, 3500);
  } else {
    if (_chatPoll) { clearInterval(_chatPoll); _chatPoll = null; }
  }
}

async function loadUserChat() {
  if (!getFbUrl()) return;
  const msgs = await fbGet('/chat');
  const container = $id('chat-msgs');
  if (!msgs || typeof msgs !== 'object') {
    container.innerHTML = '<div class="chat-empty-msg">Inicia una conversaciÃ³nâ€¦</div>';
    return;
  }
  const arr = Object.values(msgs)
    .map(m => ({...m, from: dec(m.from), text: dec(m.text), toUser: m.toUser ? dec(m.toUser) : null}))
    .filter(m => {
      if (m.isAdmin) return m.toUser === null || m.toUser === _myName; // mensajes admin para mi o para todos
      return m.from === _myName; // mis propios mensajes
    })
    .sort((a,b) => a.ts - b.ts);

  const newOnes = arr.filter(m => m.ts > _lastMsgTs && m.isAdmin);
  if (newOnes.length && !_chatOpen) {
    _newMsgs += newOnes.length;
    const badge = $id('fab-badge');
    badge.style.display = 'flex';
    badge.textContent = _newMsgs;
  }
  if (arr.length) _lastMsgTs = Math.max(...arr.map(m => m.ts));

  if (!arr.length) {
    container.innerHTML = '<div class="chat-empty-msg">Inicia una conversaciÃ³nâ€¦</div>';
    return;
  }
  container.innerHTML = arr.map(m => {
    const isMe = !m.isAdmin;
    return `<div class="cmsg ${isMe?'cmsg-mine':'cmsg-admin'}">
      <div class="cmsg-from">${m.isAdmin ? 'âœ Administrador' : esc(m.from)}</div>
      ${esc(m.text)}
      <div class="cmsg-time">${fmtTime(m.ts)}</div>
    </div>`;
  }).join('');
  container.scrollTop = container.scrollHeight;
}

async function sendUserMsg() {
  if (!_myName || _myName.length < 2) { setMsg('Escribe tu nombre primero','err'); return; }
  const inp = $id('chat-inp');
  const text = inp.value.trim();
  if (!text) return;
  if (!getFbUrl()) { alert('Sistema no configurado aÃºn. Intenta mÃ¡s tarde.'); return; }
  inp.value = '';

  // Registrar el nombre como usuario "pre-login" en Firebase si no existe sesiÃ³n
  if (!localStorage.getItem('or_key_biblia')) {
    const k = userKey(_myName);
    const existing = await fbGet('/sessions/' + k);
    if (!existing) {
      await fbSet('/sessions/'+k, {
        name: enc(_myName), or: enc(''), horde: enc(''),
        loginCount: 0, lastSeen: Date.now(), active: false, preLogin: true, revoked: false
      });
    } else {
      await fbPatch('/sessions/'+k, {lastSeen: Date.now()});
    }
  }

  await fbPush('/chat', {
    from: enc(_myName), text: enc(text),
    ts: Date.now(), isAdmin: false,
    preLogin: !localStorage.getItem('or_key_biblia')
  });
  loadUserChat();
}

function chatEnter(e) { if (e.key==='Enter' && !e.shiftKey) { e.preventDefault(); sendUserMsg(); } }

/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   LOGIN FLOW
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
async function doLogin() {
  const name  = $id('f-user').value.trim();
  const orKey = $id('f-or').value.trim();
  const hKey  = $id('f-horde').value.trim();

  if (!name) { setMsg('Introduce tu nombre de usuario','err'); $id('f-user').focus(); return; }
  if (!orKey) { setField('f-or','fail'); setMsg('Introduce la Clave IA de Texto','err'); return; }
  if (!hKey)  { setField('f-horde','fail'); setMsg('Introduce la Clave IA de ImÃ¡genes','err'); return; }

  // Admin bypass
  if (name === ADMIN_USER && orKey === ADMIN_PASS && hKey === ADMIN_PASS) {
    setBusy(true); setMsg('Verificando credencialesâ€¦','info');
    await new Promise(r => setTimeout(r, 400));
    _isAdmin = true; openAdmin(); return;
  }

  setField('f-or',''); setField('f-horde','');
  setBusy(true);

  // Verificar duplicado
  if (getFbUrl()) {
    setMsg('Verificando disponibilidadâ€¦','info');
    const k = userKey(name);
    const existing = await fbGet('/sessions/' + k);
    if (existing && !existing.preLogin && !existing.revoked) {
      const storedOr   = existing.or_override ? dec(existing.or_override) : dec(existing.or);
      const storedHorde = existing.horde_override ? dec(existing.horde_override) : dec(existing.horde);
      if (storedOr !== orKey || storedHorde !== hKey) {
        setField('f-user','fail');
        setMsg('âŒ Ese nombre de usuario ya estÃ¡ en uso. Elige otro o usa tus claves originales.','err');
        setBusy(false); return;
      }
    }
  }

  // Verificar IA de Texto
  setMsg('Verificando Clave IA de Textoâ€¦','info');
  const orOk = await checkOR(orKey);
  if (!orOk) { setField('f-or','fail'); setMsg('âŒ Clave IA de Texto invÃ¡lida o sin conexiÃ³n','err'); setBusy(false); return; }
  setField('f-or','ok');

  // Verificar IA de ImÃ¡genes
  setMsg('Verificando Clave IA de ImÃ¡genesâ€¦','info');
  const hOk = await checkHorde(hKey);
  if (!hOk) { setField('f-horde','fail'); setMsg('âŒ Clave IA de ImÃ¡genes invÃ¡lida o sin conexiÃ³n','err'); setBusy(false); return; }
  setField('f-horde','ok');

  setMsg('âœ… Acceso concedido â€” bienvenido, ' + name, 'ok');
  localStorage.setItem('biblia_username', name);
  localStorage.setItem('or_key_biblia', orKey);
  localStorage.setItem('horde_key_biblia', hKey);
  _myName = name;

  // Guardar/actualizar sesiÃ³n en Firebase
  if (getFbUrl()) await saveSession(name, orKey, hKey);

  await new Promise(r => setTimeout(r, 650));

  // Lanzar Biblia
  $id('s-login').style.opacity = '0';
  $id('s-login').style.transition = 'opacity .35s';
  $id('chat-fab').style.display = 'none';
  $id('chat-panel').style.display = 'none';
  await new Promise(r => setTimeout(r, 320));
  $id('s-load').classList.add('show');
  loadBible();
}

async function saveSession(name, orKey, hKey) {
  const k = userKey(name);
  const existing = await fbGet('/sessions/' + k);
  const loginCount = (existing?.loginCount || 0) + 1;
  const payload = {
    name: enc(name), or: enc(orKey), horde: enc(hKey),
    loginCount, lastSeen: Date.now(), active: true, preLogin: false, revoked: false
  };
  if (existing?.or_override)    payload.or_override    = existing.or_override;
  if (existing?.horde_override) payload.horde_override = existing.horde_override;
  await fbSet('/sessions/' + k, payload);
  localStorage.setItem('biblia_session_key', k);
}

/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   HEARTBEAT â€” detecta kick y override de claves
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
async function heartbeat() {
  const k = localStorage.getItem('biblia_session_key');
  if (!k || !getFbUrl()) return;
  const data = await fbGet('/sessions/' + k);
  if (!data) return;
  if (data.revoked) { clearInterval(_hbTimer); alert('âš  Tu sesiÃ³n fue cerrada por el administrador.'); location.reload(); return; }
  if (data.or_override) {
    const newOr = dec(data.or_override);
    if (newOr && newOr !== localStorage.getItem('or_key_biblia')) localStorage.setItem('or_key_biblia', newOr);
  }
  if (data.horde_override) {
    const newH = dec(data.horde_override);
    if (newH && newH !== localStorage.getItem('horde_key_biblia')) localStorage.setItem('horde_key_biblia', newH);
  }
  await fbPatch('/sessions/' + k, {lastSeen: Date.now()});
}

/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   ADMIN PANEL
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
function openAdmin() {
  $id('s-login').style.display = 'none';
  $id('chat-fab').style.display = 'none';
  $id('bg-login').style.display = 'none';
  const adm = $id('s-admin');
  adm.style.display = 'flex';

  if (!getFbUrl()) $id('fb-banner').style.display = 'block';

  loadAdminData();
  _admPoll = setInterval(loadAdminData, 4000); // cada 4 segundos
}

function adminLogout() {
  clearInterval(_admPoll);
  $id('s-admin').style.display = 'none';
  $id('s-login').style.display = '';
  $id('bg-login').style.display = '';
  ['f-user','f-or','f-horde'].forEach(id => $id(id).value = '');
  setMsg('','info'); setBusy(false); _isAdmin = false;
}

function saveFbUrl() {
  const url = $id('fb-inp').value.trim().replace(/\/$/,'');
  if (!url.startsWith('https://')) { alert('URL invÃ¡lida. Debe comenzar con https://'); return; }
  localStorage.setItem('biblia_fb_url', url);
  $id('fb-banner').style.display = 'none';
  loadAdminData();
}

async function loadAdminData() {
  if (!getFbUrl()) return;
  const [sessions, messages] = await Promise.all([fbGet('/sessions'), fbGet('/chat')]);
  renderUsers(sessions);
  renderAdminChat(messages);
  updateStats(sessions, messages);
}

function updateStats(sessions, messages) {
  const users = sessions ? Object.entries(sessions).filter(([k,v]) => !v.revoked) : [];
  const now = Date.now();
  const online = users.filter(([k,v]) => v.lastSeen && (now-v.lastSeen)<90000 && !v.preLogin).length;
  const preLogin = users.filter(([k,v]) => v.preLogin).length;
  const msgs = messages ? Object.keys(messages).length : 0;
  $id('stat-total').textContent    = users.filter(([k,v]) => !v.preLogin).length;
  $id('stat-online').textContent   = online;
  $id('stat-prelogin').textContent = preLogin;
  $id('stat-msgs').textContent     = msgs;
  $id('adm-count-badge').textContent = online + ' activa' + (online!==1?'s':'');
}

function renderUsers(sessions) {
  const col = $id('adm-users-col');
  const empty = $id('adm-empty');
  if (!sessions || !Object.keys(sessions).length) { empty.style.display='block'; return; }

  const now = Date.now();
  const users = Object.entries(sessions)
    .map(([k,v]) => ({
      key: k,
      name: dec(v.name),
      or:   dec(v.or),
      horde:dec(v.horde),
      orOv:  v.or_override    ? dec(v.or_override) : '',
      hordeOv: v.horde_override ? dec(v.horde_override) : '',
      loginCount: v.loginCount || 0,
      lastSeen: v.lastSeen || 0,
      active: v.active || false,
      preLogin: v.preLogin || false,
      revoked: v.revoked || false
    }))
    .filter(u => !u.revoked)
    .sort((a,b) => b.lastSeen - a.lastSeen);

  if (!users.length) { empty.style.display='block'; return; }
  empty.style.display = 'none';

  // Update select for chat
  const sel = $id('adm-to');
  const prevVal = sel.value;
  sel.innerHTML = '<option value="all">ğŸ“¢ Todos</option>'
    + users.filter(u => !u.preLogin).map(u => {
        const isOn = (now - u.lastSeen) < 90000;
        return `<option value="${esc(u.name)}"${u.name===prevVal?' selected':''}>${isOn?'ğŸŸ¢':' '}${esc(u.name)}</option>`;
      }).join('');

  // Render session cards
  users.forEach(u => {
    const sid = u.key;
    const isOnline = (now - u.lastSeen) < 90000;
    const elapsed = timeSince(u.lastSeen);
    const initial = (u.name||'?')[0].toUpperCase();
    const effectiveOr    = (u.orOv || u.or);
    const effectiveHorde = (u.hordeOv || u.horde);
    const orMask  = effectiveOr    ? effectiveOr.slice(0,10)+'â€¢â€¢â€¢â€¢'    : 'â€”';
    const hMask   = effectiveHorde ? effectiveHorde.slice(0,6)+'â€¢â€¢â€¢â€¢'  : 'â€”';

    // Badge de estado
    let badgeHtml = '';
    if (u.preLogin) badgeHtml = '<span class="sc-badge sc-badge-pre">PRE-LOGIN</span>';
    else if (isOnline) badgeHtml = '<span class="sc-badge sc-badge-in">EN LÃNEA</span>';
    if (u.loginCount > 2) badgeHtml += ' <span class="sc-badge sc-badge-warn">'+u.loginCount+'Ã— logins</span>';

    // Botones
    const editBtn  = `<button class="adm-btn adm-btn-purple" onclick="openEditModal('${sid}','${esc(u.name)}','${esc(effectiveOr)}','${esc(effectiveHorde)}')">âœ Claves</button>`;
    const kickBtn  = `<button class="adm-btn adm-btn-red" onclick="kickUser('${sid}','${esc(u.name)}')">âœ• Kick</button>`;

    let card = $id('sc-'+sid);
    if (!card) {
      card = document.createElement('div');
      card.id = 'sc-'+sid;
      card.className = 'sc ' + (isOnline?'online':'offline');
      col.appendChild(card);
    } else {
      card.className = 'sc ' + (isOnline?'online':'offline');
    }

    card.innerHTML = `
      <div class="sc-hdr">
        <div class="sc-av">${esc(initial)}</div>
        <div style="flex:1;min-width:0">
          <div class="sc-name">${esc(u.name)}</div>
          <div class="sc-email">Ãšltima act.: ${elapsed} atrÃ¡s</div>
        </div>
        <div style="display:flex;align-items:center;gap:6px;flex-wrap:wrap">
          <div class="sc-dot ${isOnline?'on':'off'}"></div>
          <span class="sc-status-lbl" style="color:${isOnline?'var(--teal)':'var(--muted)'}">${isOnline?'ACTIVO':'INACTIVO'}</span>
          ${badgeHtml}
          <span class="sc-time">${fmtDate(u.lastSeen)}</span>
        </div>
      </div>
      <div class="sc-info">
        <div class="sc-info-cell">
          <div class="sc-info-label">Logins</div>
          <div class="sc-info-val">${u.loginCount}</div>
        </div>
        <div class="sc-info-cell">
          <div class="sc-info-label">Clave IA Texto</div>
          <div class="sc-info-val" title="${esc(effectiveOr)}">${esc(orMask)}</div>
        </div>
        <div class="sc-info-cell">
          <div class="sc-info-label">Clave IA ImÃ¡genes</div>
          <div class="sc-info-val" title="${esc(effectiveHorde)}">${esc(hMask)}</div>
        </div>
      </div>
      <div class="sc-actions">
        ${editBtn}${kickBtn}
      </div>`;
  });

  // Eliminar cards de usuarios que ya no existen
  col.querySelectorAll('.sc[id^="sc-"]').forEach(card => {
    const k = card.id.replace('sc-','');
    if (!users.find(u => u.key === k)) card.remove();
  });
}

/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   ADMIN CHAT RENDER
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
async function renderAdminChat(messages) {
  const container = $id('adm-msgs');
  if (!messages || !Object.keys(messages).length) {
    container.innerHTML = '<div class="adm-chat-empty">Sin mensajes aÃºn.</div>';
    return;
  }
  const arr = Object.values(messages)
    .map(m => ({...m, from: dec(m.from), text: dec(m.text), toUser: m.toUser ? dec(m.toUser) : null}))
    .sort((a,b) => a.ts - b.ts);

  container.innerHTML = arr.map(m => {
    const isAdminMsg = m.isAdmin;
    const cls = isAdminMsg ? 'adm-msg-admin' : 'adm-msg-user';
    const from = isAdminMsg
      ? 'âœ Admin â†’ ' + (m.toUser || 'Todos')
      : 'ğŸ‘¤ ' + esc(m.from);
    const preTag = m.preLogin && !isAdminMsg ? '<div class="adm-msg-pre">âš  Sin login aÃºn</div>' : '';
    return `<div class="${cls}" style="border-radius:7px;padding:7px 10px;font-size:12px;font-family:'Crimson Text',serif;line-height:1.4;word-break:break-word;margin-bottom:0">
      <div class="adm-msg-from">${from}</div>
      ${esc(m.text)}${preTag}
      <div class="adm-msg-time">${fmtDate(m.ts)}</div>
    </div>`;
  }).join('');
  container.scrollTop = container.scrollHeight;
}

async function admSend() {
  const to  = $id('adm-to').value;
  const txt = $id('adm-inp').value.trim();
  if (!txt) return;
  $id('adm-inp').value = '';
  await fbPush('/chat', {
    from: enc(ADMIN_USER), text: enc(txt),
    ts: Date.now(), isAdmin: true,
    toUser: to === 'all' ? null : enc(to)
  });
  loadAdminData();
}

/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   KICK + EDIT CLAVES
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
async function kickUser(key, name) {
  if (!confirm(`Â¿Cerrar sesiÃ³n de "${name}"?`)) return;
  await fbPatch('/sessions/'+key, {revoked: true, active: false});
  loadAdminData();
}

function openEditModal(key, name, or, horde) {
  _editingKey = key;
  $id('modal-username').textContent = 'Usuario: ' + name;
  $id('modal-or').value    = or;
  $id('modal-horde').value = horde;
  $id('modal-edit').classList.add('show');
}
function closeModal() { $id('modal-edit').classList.remove('show'); _editingKey = ''; }

async function saveModalKeys() {
  if (!_editingKey) return;
  const newOr    = $id('modal-or').value.trim();
  const newHorde = $id('modal-horde').value.trim();
  const patch = {};
  if (newOr)    patch.or_override    = enc(newOr);
  if (newHorde) patch.horde_override = enc(newHorde);
  if (Object.keys(patch).length) await fbPatch('/sessions/'+_editingKey, patch);
  closeModal();
  loadAdminData();
}

/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   DESCIFRAR Y LANZAR BIBLIA
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
const _BK = ['Bibl','ia19','09RV','A-Pr','otec','tedC','onte','nt-K','ey-2','024-','GitH','ubPa','ges'];
const BIBLE_KEY = _BK.join('');
const BIBLE_KEY_B = new TextEncoder().encode(BIBLE_KEY);

function b64ToBytes(b64) { const bin=atob(b64),b=new Uint8Array(bin.length); for(let i=0;i<bin.length;i++)b[i]=bin.charCodeAt(i); return b; }
function xorDec(e,k) { const out=new Uint8Array(e.length),kl=k.length; for(let i=0;i<e.length;i++)out[i]=e[i]^k[i%kl]; return out; }
function ldProg(p,m) { $id('ld-bar').style.width=p+'%'; if(m!==undefined)$id('ld-st').textContent=m; }

async function loadBible() {
  if ('serviceWorker' in navigator) {
    try {
      const reg = await navigator.serviceWorker.register('./sw.js',{scope:'./',updateViaCache:'none'});
      if (reg.waiting) reg.waiting.postMessage({type:'SKIP_WAITING'});
    } catch(e) {}
  }
  ldProg(15,'Cargando Escriturasâ€¦');
  let encText;
  try { const r=await fetch('./bible.enc',{cache:'default'}); if(!r.ok)throw new Error(); encText=await r.text(); }
  catch(e) { const r2=await fetch('./bible.enc',{cache:'reload'}); if(!r2.ok){$id('ld-st').textContent='âš  Error cargando bible.enc';return;} encText=await r2.text(); }
  ldProg(55,'Escrituras recibidasâ€¦');

  const encBytes=b64ToBytes(encText.trim()); encText=null;
  ldProg(75,'Procesandoâ€¦');
  await new Promise(r=>setTimeout(r,20));

  const decBytes=xorDec(encBytes,BIBLE_KEY_B);
  const html=new TextDecoder('utf-8').decode(decBytes);
  ldProg(100,'Abriendoâ€¦');
  await new Promise(r=>setTimeout(r,220));

  _hbTimer = setInterval(heartbeat, 30000);
  document.open(); document.write(html); document.close();
}

/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   MISC
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
// Bloquear inspector
document.addEventListener('contextmenu', e => e.preventDefault());
document.addEventListener('keydown', e => {
  if (e.key==='F12'||(e.ctrlKey&&e.shiftKey&&'IJCU'.includes(e.key))||(e.ctrlKey&&e.key==='U')||(e.metaKey&&e.altKey&&e.key==='I'))
    { e.preventDefault(); e.stopPropagation(); }
}, true);

// Enter para login
document.addEventListener('keydown', e => {
  if (e.key==='Enter' && !$id('btn-enter').disabled && $id('s-login').style.display !== 'none'
    && document.activeElement.id !== 'chat-inp') doLogin();
});
</script>
</body>
</html>
